(()=>{let e=null,t={},a=null,s=null,o=!1,n="daughnut",c=null;function r(e){try{return e&&new URL(e).hostname||null}catch{return null}}function l(){c&&clearInterval(c),c=setInterval((()=>{var e;o&&s&&(e=s)&&(t[e][1]=(t[e][1]||0)+1,console.log(`Time incremented for ${e}:`,t[e][1]),chrome.storage.local.set({siteTimeData:t},(()=>{"list"===n&&chrome.runtime.sendMessage({type:"timeUpdateList",timeData:t}).catch((()=>{})),"daughnut"===n&&chrome.runtime.sendMessage({type:"timeUpdateDaughnut",timeData:t}).catch((()=>{}))})))}),1e3)}function i(){c&&(clearInterval(c),c=null)}function u(e,a){t[e]?t[e][0]=a:t[e]=[a,0]}function d(e,t){var a,s;e?t?u(e,t):(a=`https://${e}/favicon.ico`,s=a=>{u(e,t=a||"assets/default-favicon.png")},fetch(a).then((e=>{e.ok?s(a):s(null)})).catch((()=>s(null)))):console.error("Domain is null, skipping favicon handling.")}chrome.runtime.onMessage.addListener(((c,u,g)=>"getData"===c.type?(g({timeData:t}),!0):"startOrPause"===c.type?(o=c.status,console.log("Tracking status changed to:",o),o?chrome.tabs.query({active:!0,currentWindow:!0},(t=>{t[0]&&(e=t[0].id,s=r(t[0].url),a=t[0].favIconUrl,t[0].url.startsWith("chrome://")&&(a="assets/chrome-favicon.png"),d(s,a),l(),console.log("Started tracking for:",s))})):(i(),e=null,s=null),chrome.storage.local.set({isTracking:o}),g({status:"success"}),!0):"clear"===c.type?(t={},chrome.storage.local.set({siteTimeData:t}),console.log("Cleared time data"),g({status:"success"}),!0):"daughnut"===c.type?(n="daughnut",console.log("Displaying: ",n),g({status:"success"}),!0):"list"===c.type?(n="list",console.log("Displaying: ",n),g({status:"success"}),!0):void 0)),chrome.windows.onFocusChanged.addListener((t=>{o&&(t===chrome.windows.WINDOW_ID_NONE?(console.log("Window lost focus"),i()):(console.log("Window gained focus"),chrome.tabs.query({active:!0,currentWindow:!0},(t=>{t[0]&&(e=t[0].id,s=r(t[0].url),a=t[0].favIconUrl,t[0].url.startsWith("chrome://")&&(a="assets/chrome-favicon.png"),d(s,a),l(),console.log("Resumed tracking for:",s))}))))})),chrome.tabs.onActivated.addListener((t=>{o&&(i(),chrome.tabs.get(t.tabId,(t=>{e=t.id,s=r(t.url),a=t.favIconUrl,console.log("Current domain:",t.url),t.url.startsWith("chrome://")&&(a="assets/chrome-favicon.png"),d(s,a),l(),console.log("Tab activated:",s)})))})),chrome.tabs.onUpdated.addListener(((t,n,c)=>{o&&t===e&&n.url&&(i(),s=r(n.url),a=c.favIconUrl,c.url.startsWith("chrome://")&&(a="assets/chrome-favicon.png"),d(s,a),l(),console.log("Tab URL updated:",s))})),chrome.storage.local.get(["isTracking","siteTimeData"],(n=>{o=n.isTracking||!1,t=n.siteTimeData||{},o&&chrome.tabs.query({active:!0,currentWindow:!0},(t=>{t[0]&&(e=t[0].id,s=r(t[0].url),a=t[0].favIconUrl,t[0].url.startsWith("chrome://")&&(a="assets/chrome-favicon.png"),d(s,a),l())}))}))})();